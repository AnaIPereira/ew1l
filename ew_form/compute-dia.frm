#-
Off Statistics;
On HighFirst;

#include- form-declarations.h

#ifndef `LOOPS'
	#message Error, please specify the number of loops as LOOPS.
	#terminate
#endif
#ifndef `DIA'
	#message Error, please specify the diagram number as DIA.
	#terminate
#endif

* Load the diagram from the tapir file:
Local d`LOOPS'l`DIA'amp =
	#include- ../ew_tapir/dia/munuenu-`LOOPS'l.dia # d`LOOPS'l`DIA';

* Load the mapped topology, and make the necessary momentum replacements
#include ../ew_tapir/topo/mapping-`LOOPS'l.h # d`LOOPS'l`DIA'
`MOMREPLACEMENT'
.sort

*#include ../ew_tapir/topo/mapping-`LOOPS'l.h # d`LOOPS'l`DIA'
*`INT1'
*.sort

*#include- ../ew_tapir/dia/munuenu-`LOOPS'l.dia # d`LOOPS'l`DIA'
*`BRIDGEMOMENTA'
*.sort

*Feynman rules
* auxGamma are gamma matrices, their argument is a Lorentz index ans the spinor1 and spinor2.

Identify auxPL(i1?,i2?) = cFT(g7,XX,i1,i2)/2;
Identify auxPR(i1?,i2?) = cFT(g6,XX,i1,i2)/2;
Identify auxSlash(?a,i1?,i2?) = cFT(?a,XX,i1,i2);
Identify auxGamma(?a,i1?,i2?) = cFT(?a,XX,i1,i2);

#do i = 1,2

  Identify once cFT(?a) = FT`i'(?a);

  Repeat;
    Identify FT`i'(?a,i1?,i2?) * cFT(?b,i2?,i3?) = FT`i'(?a,XX,?b,XX,i1,i3);
    Identify cFT(?b,i3?,i1?) * FT`i'(?a,i1?,i2?) = FT`i'(?b,XX,?a,XX,i3,i2);
    Identify FT`i'(?a,i1?,i1?) = FT`i'(?a);
  EndRepeat;
  Repeat;
    Identify FT`i'(XX,?a) = FT`i'(?a);
    Identify FT`i'(?a,XX) = FT`i'(?a);
    Identify FT`i'(?a,XX,?b) = FT`i'(?a) * FT`i'(?b);
  EndRepeat;

  .sort

#enddo

*propagators substitutions
* Dtran, Dlong are fermion propagators, their arguments are 2 Lorenx indices, the runnin momentum, the gauge and mass.
Identify Dph(ind1?,ind2?,?mom,gaug?) = (d_(ind1, ind2) - (1-gaug) * Vec(ind1,?mom) * Vec(ind2,?mom) * Den(?mom))* Den(?mom);
Identify Dgoldst(?mom,gaug?) = Deng(?mom, gaug, 0);
Identify Dlong(ind1?,ind2?,?mom,gaug?,mass?) = (gaug*Vec(ind1,?mom)*Vec(ind2,?mom)*Deng(?mom,gaug,mass))* Deng(?mom,gaug,mass);
Identify Dtran(ind1?,ind2?,?mom,gaug?,mass?) = (d_(ind1, ind2)-Vec(ind1,?mom)*Vec(ind2,?mom)*Deng(?mom,gaug,mass))* Deng(?mom,gaug,mass);

#do i = 1,`NUMTRACES'
  Identify FT`i'(g7) = g7_(`i');
#enddo

#do i = 1,`NUMTRACES'
	Identify FT`i'(nu?) = g_(`i',nu);
#enddo

#do i = 1,`NUMTRACES'
	Identify FT`i'(i1?,i2?) = 1;
#enddo

Argument;
   `BRIDGEMOMENTA'
EndArgument;

*trying to map topologies into diagrams
#include ../ew_tapir/topo/mapping-`LOOPS'l.h # d`LOOPS'l`DIA'
`INT1'
Argument;
`NUMERATORMOMENTA'
EndArgument;


Print +s;
.end

*split the momenta in the numerator
SplitArg Vec;
Repeat;
Identify Vec(ind?,?a,2 *p1?,?b) = 2 *Vec(ind,?a,p1,?b);
Identify Vec(ind?,?a,3 *p1?,?b) = 3 *Vec(ind,?a,p1,?b);
Identify Vec(ind?,?a,-p1?,?b) = -Vec(ind,?a,p1,?b);
Identify Vec(ind?,p1?,p2?,?a) = Vec(ind,p1) + Vec(ind,p2,?a);
Identify Vec(ind?, ?a, q1, ?b) = 0;
Identify Vec(ind?, ?a, q2, ?b) = 0;
Identify Vec(ind?, ?a, q3, ?b) = 0;
Identify Vec(ind?, ?a, q4, ?b) = 0;
EndRepeat;

*set the momenta to zero in the propagators

*TENSOR REDUCTION
* contract all the scalar product pi^2, etc
Identify Vec(ind?,momen?)*Vec(ind?,momen?) = momen.momen;
Identify Vec(ind?,momen?)^2 = momen.momen;

*tensor reduction for rank 4
Identify Vec(ind1?,momen?)*Vec(ind2?,momen?)*Vec(ind3?,momen1?)*Vec(ind4?,momen1?) =
1/(d *(d^2 + d - 2))*(- momen.momen * momen1.momen1 + d* (momen.momen1)^2)*(d_(ind1,ind3)*d_(ind2,ind4) + d_(ind1,ind4)*d_(ind2,ind3));

Identify Vec(ind1?,momen?)*Vec(ind2?,momen1?)*Vec(ind3?,momen1?)*Vec(ind4?,momen1?) =
1/(d^2+2*d)*(momen.momen1)*(momen1.momen1)*(d_(ind1,ind2)*d_(ind3,ind4)+d_(ind1,ind4)*d_(ind3,ind2)+d_(ind1,ind3)*d_(ind2,ind4));

*tensor reduction for rank 2
Identify Vec(ind?,momen?)*Vec(ind1?,momen1?) = 1/d* momen.momen1 * d_(ind,ind1);

* Compute the traces:
*Tracen,1;
*Tracen,2;
*.sort

*Print +s;
*.end

*project in operator basis
Identify g_(1,6_,ind?)*g_(2,6_,ind?) = Op;
.sort

*Print +s;
*.end



* Write the propagators into the notation expected by the tapir topology file.
* Massive, simj = 1/(Mj^2 - pi.pi)
* Massless, 1/(-pi.pi)

#do i = 1,`NUMPROPS'
	Repeat Identify Den( p`i',M`j') = s`i'mj;
	Repeat Identify Den( p`i',0) = -1/p`i'.p`i';
	Repeat Identify Den(-p`i',0) = -1/p`i'.p`i';
#enddo
.sort

Print +s;
.end

* Include the topology file generated by tapir, to write scalar products
* as inverse propagators.
*#include- /home/ana/Documents/Software/src/tapir/ew/topo/`INT1'


* Clean up the notation:
*PolyRatFun prf;
* Kinematics
*Identify q1.q1 = 0;
*Identify q2.q2 = 0;
*Identify q1.q2 = prf(s,2);
*Identify M1^2 = prf(mts,1);
*Identify s^n1? = prf(s^n1,1);
*Identify d^n1? = prf(d^n1,1);
.sort

** Insert the IBP reduction rules from Kira:
*#include ../kira-`LOOPS'l/results/`INT1'/kira_`INT1'.inc
*Identify num(s?) = prf(s,1);
*Identify den(s?) = prf(1,s);
*Identify mts^n1? = prf(mts^n1,1);
*Identify s^n1? = prf(s^n1,1);
*Identify d^n1? = prf(d^n1,1);



* Write the result to a file:
*.sort
*#write <results/d`LOOPS'l`DIA'.h> "%E", d`LOOPS'l`DIA'amp

*Bracket d2l1,...,d2l21;
*Print +s;
*.end
